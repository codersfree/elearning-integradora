<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/instructor}">

<head>
    <title th:text="|Metas: ${course.name}|">Metas del Curso</title>
    <meta name="description" content="Metas del curso.">
</head>

<body>
<div layout:fragment="content">

    <div class="row g-4">
        <!-- Menú lateral -->
        <div class="col-lg-3">
            <div th:replace="~{layouts/fragments/instructor/course-edit-nav :: navigation(course=${course}, activePage='goals')}"></div>
        </div>

        <!-- Contenido -->
        <div class="col-lg-9">
            <div x-data="goalManager()">

                <!-- Contenedor global de mensajes -->
                <form @submit.prevent="updateGoals">

                    <div class="card shadow-sm border-0 rounded-lg">
                        <div class="card-body p-4 p-md-5">

                            <h1 class="h3 fw-bold mb-0">Llega a tus estudiantes</h1>
                            <p class="text-muted mb-0">
                                Las metas que escribas aquí ayudarán a los estudiantes a decidir si
                                tu curso es el adecuado para ellos.
                            </p>

                            <hr class="my-4">

                            <!-- Lista dinámica -->
                            <template x-for="(goal, index) in goals" :key="goal.id || ('new_' + index)">
                                <div class="mb-3">
                                    <div class="input-group">
                                        <input type="hidden" :name="'goals[' + index + '].id'" x-model="goal.id">
                                        <input type="text" class="form-control form-control-lg"
                                               :name="'goals[' + index + '].name'"
                                               x-model="goal.name"
                                               placeholder="Nombre de la meta" required>
                                        <button @click.prevent="removeGoal(index)"
                                                class="btn btn-outline-danger d-flex align-items-center"
                                                type="button"
                                                :disabled="isDeleting[index]">
                                            <i class="fas fa-trash" x-show="!isDeleting[index]"></i>
                                            <span x-show="isDeleting[index]"
                                                  class="spinner-border spinner-border-sm" role="status"
                                                  aria-hidden="true"></span>
                                        </button>
                                    </div>
                                </div>
                            </template>

                            <template x-if="goals.length === 0">
                                <p class="text-muted text-center my-3">Aún no has agregado ninguna meta.</p>
                            </template>

                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-dark btn-lg px-4"
                                        @click.prevent="updateGoals"
                                        :disabled="isUpdating">
                                    <span x-show="!isUpdating">Actualizar Metas</span>
                                    <span x-show="isUpdating" class="spinner-border spinner-border-sm"
                                          role="status" aria-hidden="true"></span>
                                    <span x-show="isUpdating"> Actualizando...</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>

                <div x-show="message"
                     x-transition
                     class="alert alert-dismissible fade show mt-4"
                     :class="messageType === 'success' ? 'alert-success' : 'alert-danger'"
                     role="alert">
                    <span x-text="message"></span>
                    <button type="button" class="btn-close" @click="message = null" aria-label="Close"></button>
                </div>

                <!-- Nueva meta -->
                <div class="card shadow-sm border-0 rounded-lg mt-4 bg-light">
                    <div class="card-body p-4 p-md-5">
                        <label for="newGoalInput" class="form-label fw-bold">
                            Nueva meta
                        </label>

                        <div class="input-group mb-3">
                            <input id="newGoalInput" type="text" class="form-control form-control-lg"
                                   placeholder="Ingrese el nombre de la meta"
                                   x-model="newGoalName"
                                   @keydown.enter.prevent="addNewGoal()">
                        </div>

                        <div class="text-end">
                            <button type="button" class="btn btn-danger btn-lg px-4 me-2"
                                    @click="newGoalName = ''">Cancelar</button>
                            <button type="button" class="btn btn-dark btn-lg px-4"
                                    @click.prevent="addNewGoal()"
                                    :disabled="newGoalName.trim() === '' || isLoading">
                                <span x-show="!isLoading">Agregar</span>
                                <span x-show="isLoading" class="spinner-border spinner-border-sm"
                                      role="status" aria-hidden="true"></span>
                                <span x-show="isLoading"> Agregando...</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Alpine.js -->
<script layout:fragment="js" th:inline="javascript">
    function goalManager() {
        return {
            goals: /*[[${goals}]]*/ [],
            newGoalName: '',

            // --- Estado global ---
            message: null,
            messageType: null, // 'success', 'error'

            // --- Estado de carga ---
            isLoading: false,
            isUpdating: false,
            isDeleting: {},

            api: {
                base: /*[[@{/api/instructor/courses/{slug}/goals(slug=${course.slug})}]]*/ '',
                delete: /*[[@{/api/instructor/courses/goals/}]]*/ ''
            },

            showMessage(text, type = 'success', duration = 3000) {
                this.message = text;
                this.messageType = type;
                if (duration) setTimeout(() => this.message = null, duration);
            },

            async parseErrorResponse(response) {
                try {
                    const data = await response.json();

                    // Manejar validación de Spring Boot
                    if (data.errors && Array.isArray(data.errors)) {
                        return data.errors.map(err => err.defaultMessage).join(', ');
                    }

                    // Otros errores
                    if (data.message) return data.message;
                    if (data.error) return data.error;

                    return JSON.stringify(data);
                } catch {
                    return await response.text();
                }
            },

            async apiRequest(url, { method = 'GET', body = null, successMessage = null } = {}) {
                try {
                    const response = await fetch(url, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        ...(body && { body: JSON.stringify(body) })
                    });

                    if (!response.ok) {
                        const errorMessage = await this.parseErrorResponse(response);
                        this.showMessage(errorMessage || 'Error en la operación', 'error', 5000);
                        throw new Error(errorMessage);
                    }

                    const data = response.status === 204 ? null : await response.json();

                    if (successMessage) {
                        this.showMessage(successMessage, 'success');
                    }

                    return data;

                } catch (e) {
                    console.error(e);
                    if (!this.message) {
                        this.showMessage(e.message || 'Error en la operación', 'error', 5000);
                    }
                    throw e;
                }
            },

            async addNewGoal() {
                if (!this.newGoalName.trim()) return;
                this.isLoading = true;

                try {
                    const goal = await this.apiRequest(this.api.base, {
                        method: 'POST',
                        body: { name: this.newGoalName },
                        successMessage: 'Meta creada correctamente.'
                    });

                    this.goals.push(goal);
                    this.newGoalName = '';
                } finally {
                    this.isLoading = false;
                }
            },

            async updateGoals() {
                this.isUpdating = true;
                try {
                    await this.apiRequest(this.api.base, {
                        method: 'PUT',
                        body: this.goals,
                        successMessage: 'Metas actualizadas correctamente.'
                    });
                } finally {
                    this.isUpdating = false;
                }
            },

            async removeGoal(index) {
                const goal = this.goals[index];
                if (!goal?.id) return this.goals.splice(index, 1);

                this.isDeleting[index] = true;

                try {
                    await this.apiRequest(this.api.delete + goal.id, {
                        method: 'DELETE',
                        successMessage: 'Meta eliminada correctamente.'
                    });
                    this.goals.splice(index, 1);
                } finally {
                    this.isDeleting[index] = false;
                }
            }
        };
    }
</script>

</body>
</html>
